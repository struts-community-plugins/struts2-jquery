// Grouping module
(function(a){a.extend(a.jgrid,{template:function(e){var c=a.makeArray(arguments).slice(1),b,d=c.length;if(e==null){e=""}return e.replace(/\{([\w\-]+)(?:\:([\w\.]*)(?:\((.*?)?\))?)?\}/g,function(f,j){if(!isNaN(parseInt(j,10))){return c[parseInt(j,10)]}for(b=0;b<d;b++){if(a.isArray(c[b])){var h=c[b],g=h.length;while(g--){if(j===h[g].nm){return h[g].v}}}}})}});a.jgrid.extend({groupingSetup:function(){return this.each(function(){var g=this,e,d,f,c=g.p.colModel,b=g.p.groupingView;if(b!==null&&((typeof b==="object")||a.isFunction(b))){if(!b.groupField.length){g.p.grouping=false}else{if(b.visibiltyOnNextGrouping===undefined){b.visibiltyOnNextGrouping=[]}b.lastvalues=[];if(!b._locgr){b.groups=[]}b.counters=[];for(e=0;e<b.groupField.length;e++){if(!b.groupOrder[e]){b.groupOrder[e]="asc"}if(!b.groupText[e]){b.groupText[e]="{0}"}if(typeof b.groupColumnShow[e]!=="boolean"){b.groupColumnShow[e]=true}if(typeof b.groupSummary[e]!=="boolean"){b.groupSummary[e]=false}if(!b.groupSummaryPos[e]){b.groupSummaryPos[e]="footer"}if(b.groupColumnShow[e]===true){b.visibiltyOnNextGrouping[e]=true;a(g).jqGrid("showCol",b.groupField[e])}else{b.visibiltyOnNextGrouping[e]=a("#"+a.jgrid.jqID(g.p.id+"_"+b.groupField[e])).is(":visible");a(g).jqGrid("hideCol",b.groupField[e])}}b.summary=[];if(b.hideFirstGroupCol){b.formatDisplayField[0]=function(h){return h}}for(d=0,f=c.length;d<f;d++){if(b.hideFirstGroupCol){if(!c[d].hidden&&b.groupField[0]===c[d].name){c[d].formatter=function(){return""}}}if(c[d].summaryType){if(c[d].summaryDivider){b.summary.push({nm:c[d].name,st:c[d].summaryType,v:"",sd:c[d].summaryDivider,vd:"",sr:c[d].summaryRound,srt:c[d].summaryRoundType||"round"})}else{b.summary.push({nm:c[d].name,st:c[d].summaryType,v:"",sr:c[d].summaryRound,srt:c[d].summaryRoundType||"round"})}}}}}else{g.p.grouping=false}})},groupingPrepare:function(b,c){this.each(function(){var l=this.p.groupingView,e=this,f,k=l.groupField.length,m,j,h,g,d=0;for(f=0;f<k;f++){m=l.groupField[f];h=l.displayField[f];j=b[m];g=h==null?null:b[h];if(g==null){g=j}if(j!==undefined){if(c===0){l.groups.push({idx:f,dataIndex:m,value:j,displayValue:g,startRow:c,cnt:1,summary:[]});l.lastvalues[f]=j;l.counters[f]={cnt:1,pos:l.groups.length-1,summary:a.extend(true,[],l.summary)};a.each(l.counters[f].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(e,this.v,this.nm,b)}else{this.v=a(e).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b);if(this.st.toLowerCase()==="avg"&&this.sd){this.vd=a(e).jqGrid("groupingCalculations.handler",this.st,this.vd,this.sd,this.sr,this.srt,b)}}});l.groups[l.counters[f].pos].summary=l.counters[f].summary}else{if(typeof j!=="object"&&(a.isArray(l.isInTheSameGroup)&&a.isFunction(l.isInTheSameGroup[f])?!l.isInTheSameGroup[f].call(e,l.lastvalues[f],j,f,l):l.lastvalues[f]!==j)){l.groups.push({idx:f,dataIndex:m,value:j,displayValue:g,startRow:c,cnt:1,summary:[]});l.lastvalues[f]=j;d=1;l.counters[f]={cnt:1,pos:l.groups.length-1,summary:a.extend(true,[],l.summary)};a.each(l.counters[f].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(e,this.v,this.nm,b)}else{this.v=a(e).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b);if(this.st.toLowerCase()==="avg"&&this.sd){this.vd=a(e).jqGrid("groupingCalculations.handler",this.st,this.vd,this.sd,this.sr,this.srt,b)}}});l.groups[l.counters[f].pos].summary=l.counters[f].summary}else{if(d===1){l.groups.push({idx:f,dataIndex:m,value:j,displayValue:g,startRow:c,cnt:1,summary:[]});l.lastvalues[f]=j;l.counters[f]={cnt:1,pos:l.groups.length-1,summary:a.extend(true,[],l.summary)};a.each(l.counters[f].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(e,this.v,this.nm,b)}else{this.v=a(e).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b);if(this.st.toLowerCase()==="avg"&&this.sd){this.vd=a(e).jqGrid("groupingCalculations.handler",this.st,this.vd,this.sd,this.sr,this.srt,b)}}});l.groups[l.counters[f].pos].summary=l.counters[f].summary}else{l.counters[f].cnt+=1;l.groups[l.counters[f].pos].cnt=l.counters[f].cnt;a.each(l.counters[f].summary,function(){if(a.isFunction(this.st)){this.v=this.st.call(e,this.v,this.nm,b)}else{this.v=a(e).jqGrid("groupingCalculations.handler",this.st,this.v,this.nm,this.sr,this.srt,b);if(this.st.toLowerCase()==="avg"&&this.sd){this.vd=a(e).jqGrid("groupingCalculations.handler",this.st,this.vd,this.sd,this.sr,this.srt,b)}}});l.groups[l.counters[f].pos].summary=l.counters[f].summary}}}}}});return this},groupingToggle:function(b){this.each(function(){var s=this,h=s.p.groupingView,u=b.split("_"),g=parseInt(u[u.length-2],10);u.splice(u.length-2,2);var f=u.join("_"),c=h.minusicon,t=h.plusicon,q=a("#"+a.jgrid.jqID(b)),k=q.length?q[0].nextSibling:null,i=a("#"+a.jgrid.jqID(b)+" span.tree-wrap-"+s.p.direction),p=function(r){var v=a.map(r.split(" "),function(w){if(w.substring(0,f.length+1)===f+"_"){return parseInt(w.substring(f.length+1),10)}});return v.length>0?v[0]:undefined},n,j,d=false,l=s.p.frozenColumns?s.p.id+"_frozen":false,m=l?a("#"+a.jgrid.jqID(b),"#"+a.jgrid.jqID(l)):false,o=(m&&m.length)?m[0].nextSibling:null;if(i.hasClass(c)){if(h.showSummaryOnHide){if(k){while(k){if(a(k).hasClass("jqfoot")){var e=parseInt(a(k).attr("jqfootlevel"),10);if(e<=g){break}}a(k).hide();k=k.nextSibling;if(l){a(o).hide();o=o.nextSibling}}}}else{if(k){while(k){n=p(k.className);if(n!==undefined&&n<=g){break}a(k).hide();k=k.nextSibling;if(l){a(o).hide();o=o.nextSibling}}}}i.removeClass(c).addClass(t);d=true}else{if(k){j=undefined;while(k){n=p(k.className);if(j===undefined){j=n===undefined}if(n!==undefined){if(n<=g){break}if(n===g+1){a(k).show().find(">td>span.tree-wrap-"+s.p.direction).removeClass(c).addClass(t);if(l){a(o).show().find(">td>span.tree-wrap-"+s.p.direction).removeClass(c).addClass(t)}}}else{if(j){a(k).show();if(l){a(o).show()}}}k=k.nextSibling;if(l){o=o.nextSibling}}}i.removeClass(t).addClass(c)}a(s).triggerHandler("jqGridGroupingClickGroup",[b,d]);if(a.isFunction(s.p.onClickGroup)){s.p.onClickGroup.call(s,b,d)}});return false},groupingRender:function(d,e,c,b){return this.each(function(){var i=this,r=i.p.groupingView,m="",n="",o,q,k=r.groupCollapse?r.plusicon:r.minusicon,f,l=[],j=r.groupField.length;k+=" tree-wrap-"+i.p.direction;a.each(i.p.colModel,function(t,v){var u;for(u=0;u<j;u++){if(r.groupField[u]===v.name){l[u]=t;break}}});var h=0;function s(w,x,t){var u=false,v;if(x===0){u=t[w]}else{var y=t[w].idx;if(y===0){u=t[w]}else{for(v=w;v>=0;v--){if(t[v].idx===y-x){u=t[v];break}}}}return u}function g(v,A,D,y){var w=s(v,A,D),B=i.p.colModel,z,C=w.cnt,x="",u;for(u=y;u<e;u++){var t="<td "+i.formatCol(u,1,"")+">&#160;</td>",E="{0}";a.each(w.summary,function(){if(this.nm===B[u].name){if(B[u].summaryTpl){E=B[u].summaryTpl}if(typeof this.st==="string"&&this.st.toLowerCase()==="avg"){if(this.sd&&this.vd){this.v=(this.v/this.vd)}else{if(this.v&&C>0){this.v=(this.v/C)}}}try{this.groupCount=w.cnt;this.groupIndex=w.dataIndex;this.groupValue=w.value;z=i.formatter("",this.v,u,this)}catch(F){z=this.v}t="<td "+i.formatCol(u,1,"")+">"+a.jgrid.format(E,z)+"</td>";return false}});x+=t}return x}var p=a.makeArray(r.groupSummary);p.reverse();a.each(r.groups,function(y,v){if(r._locgr){if(!(v.startRow+v.cnt>(c-1)*b&&v.startRow<c*b)){return true}}h++;q=i.p.id+"ghead_"+v.idx;o=q+"_"+y;n="<span style='cursor:pointer;' class='ui-icon "+k+"' onclick=\"jQuery('#"+a.jgrid.jqID(i.p.id)+"').jqGrid('groupingToggle','"+o+"');return false;\"></span>";try{if(a.isArray(r.formatDisplayField)&&a.isFunction(r.formatDisplayField[v.idx])){v.displayValue=r.formatDisplayField[v.idx].call(i,v.displayValue,v.value,i.p.colModel[l[v.idx]],v.idx,r);f=v.displayValue}else{f=i.formatter(o,v.displayValue,l[v.idx],v.value)}}catch(E){f=v.displayValue}if(r.groupSummaryPos[v.idx]==="header"){m+='<tr id="'+o+'"'+(r.groupCollapse&&v.idx>0?' style="display:none;" ':" ")+'role="row" class= "ui-widget-content jqgroup ui-row-'+i.p.direction+" "+q+'"><td style="padding-left:'+(v.idx*12)+'px;">'+n+a.jgrid.template(r.groupText[v.idx],f,v.cnt,v.summary)+"</td>";m+=g(y,v.idx-1,r.groups,1);m+="</tr>"}else{m+='<tr id="'+o+'"'+(r.groupCollapse&&v.idx>0?' style="display:none;" ':" ")+'role="row" class= "ui-widget-content jqgroup ui-row-'+i.p.direction+" "+q+'"><td style="padding-left:'+(v.idx*12)+'px;" colspan="'+e+'">'+n+a.jgrid.template(r.groupText[v.idx],f,v.cnt,v.summary)+"</td></tr>"}var A=j-1===v.idx;if(A){var B=r.groups[y+1],t,D,x=0,u=v.startRow,w=B!==undefined?r.groups[y+1].startRow:d.length;if(r._locgr){x=(c-1)*b;if(x>v.startRow){u=x}}for(t=u;t<w;t++){if(!d[t-x]){break}m+=d[t-x].join("")}if(r.groupSummaryPos[v.idx]!=="header"){var z;if(B!==undefined){for(z=0;z<r.groupField.length;z++){if(B.dataIndex===r.groupField[z]){break}}h=r.groupField.length-z}for(D=0;D<h;D++){if(!p[D]){continue}var C="";if(r.groupCollapse&&!r.showSummaryOnHide){C=' style="display:none;"'}m+="<tr"+C+' jqfootlevel="'+(v.idx-D)+'" role="row" class="ui-widget-content jqfoot ui-row-'+i.p.direction+'">';m+=g(y,D,r.groups,0);m+="</tr>"}h=z}}});a("#"+a.jgrid.jqID(i.p.id)+" tbody:first").append(m);m=null})},groupingGroupBy:function(c,b){return this.each(function(){var f=this;if(typeof c==="string"){c=[c]}var d=f.p.groupingView;f.p.grouping=true;if(d.visibiltyOnNextGrouping===undefined){d.visibiltyOnNextGrouping=[]}var e;for(e=0;e<d.groupField.length;e++){if(!d.groupColumnShow[e]&&d.visibiltyOnNextGrouping[e]){a(f).jqGrid("showCol",d.groupField[e])}}for(e=0;e<c.length;e++){d.visibiltyOnNextGrouping[e]=a("#"+a.jgrid.jqID(f.p.id)+"_"+a.jgrid.jqID(c[e])).is(":visible")}f.p.groupingView=a.extend(f.p.groupingView,b||{});d.groupField=c;a(f).trigger("reloadGrid")})},groupingRemove:function(b){return this.each(function(){var e=this;if(b===undefined){b=true}e.p.grouping=false;if(b===true){var c=e.p.groupingView,d;for(d=0;d<c.groupField.length;d++){if(!c.groupColumnShow[d]&&c.visibiltyOnNextGrouping[d]){a(e).jqGrid("showCol",c.groupField)}}a("tr.jqgroup, tr.jqfoot","#"+a.jgrid.jqID(e.p.id)+" tbody:first").remove();a("tr.jqgrow:hidden","#"+a.jgrid.jqID(e.p.id)+" tbody:first").show()}else{a(e).trigger("reloadGrid")}})},groupingCalculations:{handler:function(f,i,g,j,h,b){var c={sum:function(){return parseFloat(i||0)+parseFloat((b[g]||0))},min:function(){if(i===""){return parseFloat(b[g]||0)}return Math.min(parseFloat(i),parseFloat(b[g]||0))},max:function(){if(i===""){return parseFloat(b[g]||0)}return Math.max(parseFloat(i),parseFloat(b[g]||0))},count:function(){if(i===""){i=0}if(b.hasOwnProperty(g)){return i+1}return 0},avg:function(){return c.sum()}};if(!c[f]){throw ("jqGrid Grouping No such method: "+f)}var e=c[f]();if(j!=null){if(h==="fixed"){e=e.toFixed(j)}else{var d=Math.pow(10,j);e=Math.round(e*d)/d}}return e}}})})(jQuery);